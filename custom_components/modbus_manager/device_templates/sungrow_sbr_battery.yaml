# Sungrow SBR Battery Template for Modbus Manager
# Extracted from Sungrow SHx Dynamic Template
# All SBR Battery sensors, controls, calculated, binary sensors


name: "Sungrow SBR Battery"
description: "Template for Sungrow SBR and SBH battery systems (Modbus via inverter). Contains all battery sensors, controls, and diagnostics."
manufacturer: "Sungrow"
model: "SBR Battery"
version: 1.1.0
default_prefix: "SBR"
default_slave_id: 200
type: "battery"
firmware_version: "22011.01.19"
# SBR Battery only works via LAN; WiNet-S connection is not supported
requires_connection_type: "LAN"
config_flow_note: "Requires LAN connection. WiNet-S is not supported."

# Dynamic configuration support
dynamic_config:

  valid_models:
    # SBR Battery Models (SH-RS / SH-RT / SH-T compatible)
    # Module count and max_power (W) from datasheet; 30A max charge/discharge
    "SBR096": {modules: 3, max_power: 5760}
    "SBR128": {modules: 4, max_power: 7680}
    "SBR160": {modules: 5, max_power: 9600}
    "SBR192": {modules: 6, max_power: 11520}
    "SBR224": {modules: 7, max_power: 13440}
    "SBR256": {modules: 8, max_power: 15360}

    # SBH Battery Models (SH-T compatible only; same Modbus map via inverter, slave 200)
    # 5 kWh per module, 2–8 modules per unit; up to 50A, max power >25 kW
    "SBH100": {modules: 2, max_power: 6400}
    "SBH150": {modules: 3, max_power: 9600}
    "SBH200": {modules: 4, max_power: 12800}
    "SBH250": {modules: 5, max_power: 16000}
    "SBH300": {modules: 6, max_power: 19200}
    "SBH350": {modules: 7, max_power: 22400}
    "SBH400": {modules: 8, max_power: 25600}

  # Battery configuration for SBR template
  battery_config:
    description: "Battery configuration"
    options: ["sbr_battery"]
    option_labels:
      sbr_battery: "SBR Battery"
    default: "sbr_battery"

  firmware_version:
    description: "Firmware version"
    options: ["22011.01.19"]
    default: "22011.01.19"

sensors:
  # SBR Battery Sensors
  - name: Battery 1 Voltage
    unique_id: battery_1_voltage
    address: 10740 # reg 10741;Bat Spannung 0.1 V; 2010
    input_type: input
    data_type: uint16
    scale: 0.1
    precision: 1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    icon: "mdi:battery-outline"
    group: "battery_voltage"

  - name: Battery 1 Current
    unique_id: battery_1_current
    address: 10741 # reg 10742;Bat Strom 0.1 A; 1
    input_type: input
    data_type: int16
    scale: 0.1
    precision: 1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: measurement
    scan_interval: 10
    group: "battery_current"

  - name: Battery 1 Temperature
    unique_id: battery_1_temperature
    address: 10742 # reg 10743;Bat Temp 0.1 °C; 215
    input_type: input
    data_type: uint16
    scale: 0.1
    precision: 1
    unit_of_measurement: "°C"
    device_class: "temperature"
    state_class: measurement
    scan_interval: 30
    group: "battery_temperature"

  - name: Battery 1 SOC
    unique_id: battery_1_soc
    address: 10743 # reg 10744;SOC 0.1%; 1000
    input_type: input
    data_type: uint16
    scale: 0.1
    precision: 1
    unit_of_measurement: "%"
    device_class: "battery"
    state_class: measurement
    scan_interval: 30
    group: "battery_soc"

  - name: Battery 1 SOH
    unique_id: battery_1_soh
    address: 10744 # reg 10745;SOH %, 99
    input_type: input
    data_type: uint16
    scale: 1
    precision: 1
    unit_of_measurement: "%"
    device_class: "battery"
    state_class: measurement
    scan_interval: 60
    group: "battery_soh"

  - name: Battery 1 Total Battery Charge
    unique_id: battery_1_total_battery_charge
    address: 10745 # reg 10746-10747; in Batt gespeichert total kWh; 22751
    input_type: input
    data_type: uint32
    swap: word
    scale: 0.1
    precision: 1
    unit_of_measurement: "kWh"
    device_class: "energy"
    state_class: total_increasing
    scan_interval: 30
    group: "battery"

  - name: Battery 1 Total Battery Discharge
    unique_id: battery_1_total_battery_discharge
    address: 10747 # reg 10748-10749; aus Batt entnommen total kWh; 21501
    input_type: input
    data_type: uint32
    swap: word
    scale: 0.1
    precision: 1
    unit_of_measurement: "kWh"
    device_class: "energy"
    state_class: total_increasing
    scan_interval: 30
    group: "battery"

  - name: Battery 1 Max Voltage of Cell
    unique_id: battery_1_max_voltage_of_cell
    address: 10756 # reg 10757;Max.Voltage of Cell 0.1mV; 33457 (also 3.3457 Volt)
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    icon: "mdi:battery-plus-variant"
    group: "battery"

  - name: Battery 1 Position of Max Voltage Cell
    unique_id: battery_1_position_of_max_voltage_cell
    address: 10757 # reg 10758;Position of Max.Voltage Cell; 518
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 10
    group: "battery"

  - name: Battery 1 Min Voltage of Cell
    unique_id: battery_1_min_voltage_of_cell
    address: 10758 # reg 10759;Min.Voltage of Cell 0.1mV; 33390
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    icon: "mdi:battery-minus-variant"
    group: "battery"

  - name: Battery 1 Position of Min Voltage Cell
    unique_id: battery_1_position_of_min_voltage_cell
    address: 10759 # reg 10760;Position of Min.Voltage Cell; 788
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 10
    group: "battery"

  - name: Battery 1 Max Temperature of Module
    unique_id: battery_1_max_temperature_of_module
    address: 10760 # reg 10761;Max. Temp. of Module 0.1 °C; 218
    input_type: input
    data_type: uint16
    scale: 0.1
    precision: 1
    unit_of_measurement: "°C"
    device_class: "temperature"
    state_class: measurement
    scan_interval: 10
    group: "battery"

  - name: Battery 1 Position of Max Temperature of Module
    unique_id: battery_1_position_of_max_temperature_of_module
    address: 10761 # reg 10762; Pos of Max. Temp. of Module ; 514
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 10
    group: "battery"

  - name: Battery 1 Min Temperature of Module
    unique_id: battery_1_min_temperature_of_module
    address: 10762 # reg 10763;Min. Temp. of Module 0.1 °C; 206
    input_type: input
    data_type: uint16
    scale: 0.1
    precision: 1
    unit_of_measurement: "°C"
    device_class: "temperature"
    state_class: measurement
    scan_interval: 10
    group: "battery"

  - name: Battery 1 Position of Min Temperature of Module
    unique_id: battery_1_position_of_min_temperature_of_module
    address: 10763 # reg 10764; Pos of Min. Temp. of Module ; 257
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 10
    group: "battery"

  # Cell Voltage Sensors for BALANCING Analysis
  - name: Battery 1 Max Cell Voltage of Module 1
    unique_id: battery_1_max_cell_voltage_of_module_1
    address: 10764 # reg 10765;Max. Cell Voltage of Module 1 0.1mV; 33440
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 2
    unique_id: battery_1_max_cell_voltage_of_module_2
    address: 10765 # reg 10766;Max. Cell Voltage of Module 2 0.1mV; 33457
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 3
    unique_id: battery_1_max_cell_voltage_of_module_3
    address: 10766 # reg 10767;Max. Cell Voltage of Module 3 0.1mV; 33440
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 4
    unique_id: battery_1_max_cell_voltage_of_module_4
    address: 10767 # reg 10768;Max. Cell Voltage of Module 4 0.1mV; 33440
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 5
    unique_id: battery_1_max_cell_voltage_of_module_5
    address: 10768 # reg 10769;Max. Cell Voltage of Module 5 0.1mV; 33440
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 6
    unique_id: battery_1_max_cell_voltage_of_module_6
    address: 10769
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 7
    unique_id: battery_1_max_cell_voltage_of_module_7
    address: 10770
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Max Cell Voltage of Module 8
    unique_id: battery_1_max_cell_voltage_of_module_8
    address: 10771
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 1
    unique_id: battery_1_min_cell_voltage_of_module_1
    address: 10772
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 2
    unique_id: battery_1_min_cell_voltage_of_module_2
    address: 10773
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 3
    unique_id: battery_1_min_cell_voltage_of_module_3
    address: 10774
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 4
    unique_id: battery_1_min_cell_voltage_of_module_4
    address: 10775
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 5
    unique_id: battery_1_min_cell_voltage_of_module_5
    address: 10776
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 6
    unique_id: battery_1_min_cell_voltage_of_module_6
    address: 10777
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 7
    unique_id: battery_1_min_cell_voltage_of_module_7
    address: 10778
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  - name: Battery 1 Min Cell Voltage of Module 8
    unique_id: battery_1_min_cell_voltage_of_module_8
    address: 10779
    input_type: input
    data_type: uint16
    scale: 0.0001
    precision: 4
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: measurement
    scan_interval: 10
    group: "battery_cells"

  # Cell Type Sensors
  - name: Battery 1 Cell Type of Module 1
    unique_id: battery_1_cell_type_of_module_1
    address: 10780 # reg 10781;Cell Type of Module 1; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 2
    unique_id: battery_1_cell_type_of_module_2
    address: 10781 # reg 10782;Cell Type of Module 2; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 3
    unique_id: battery_1_cell_type_of_module_3
    address: 10782 # reg 10783;Cell Type of Module 3; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 4
    unique_id: battery_1_cell_type_of_module_4
    address: 10783 # reg 10784;Cell Type of Module 4; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 5
    unique_id: battery_1_cell_type_of_module_5
    address: 10784 # reg 10785;Cell Type of Module 5; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 6
    unique_id: battery_1_cell_type_of_module_6
    address: 10785 # reg 10786;Cell Type of Module 6; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 7
    unique_id: battery_1_cell_type_of_module_7
    address: 10786 # reg 10787;Cell Type of Module 7; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  - name: Battery 1 Cell Type of Module 8
    unique_id: battery_1_cell_type_of_module_8
    address: 10787 # reg 10788;Cell Type of Module 8; 1
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  # DC Switch State
  - name: Battery 1 State of DC Switch
    unique_id: battery_1_state_of_dc_switch
    address: 10788 # reg 10789;Zustand DC-Schütz; 2
    input_type: input
    data_type: uint16
    scale: 1
    precision: 0
    scan_interval: 120
    group: "battery"

  # Module Serial Numbers (dynamisch je nach Modell)
  - name: Battery 1 module 1 serial number
    unique_id: battery_1_module_1_sn
    address: 10821 # reg 10822
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"
    condition: "modules >= 1"

  - name: Battery 1 module 2 serial number
    unique_id: battery_1_module_2_sn
    address: 10830 # reg 10831
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"
    condition: "modules >= 2"

  - name: Battery 1 module 3 serial number
    unique_id: battery_1_module_3_sn
    address: 10839 # reg 10840
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"
    condition: "modules >= 3"

  - name: Battery 1 module 4 serial number
    unique_id: battery_1_module_4_sn
    address: 10848 # reg 10849
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"

  - name: Battery 1 module 5 serial number
    unique_id: battery_1_module_5_sn
    address: 10857 # reg 10858
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"

  - name: Battery 1 module 6 serial number
    unique_id: battery_1_module_6_sn
    address: 10866 # reg 10867
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"

  - name: Battery 1 module 7 serial number
    unique_id: battery_1_module_7_sn
    address: 10875 # reg 10876
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"

  - name: Battery 1 module 8 serial number
    unique_id: battery_1_module_8_sn
    address: 10884 # reg 10885
    input_type: input
    data_type: string
    count: 9
    scan_interval: 600
    group: "battery"

  # Battery Status Array
  # - name: Battery 1 Status Array
  #   unique_id: battery_1_status_array
  #   address: 10720 # reg 10721 - 10730; Batt Status; 0,0,0,0,0,0,0,0,0,0
  #   input_type: input
  #   data_type: uint16
  #   scale: 1
  #   precision: 0
  #   count: 10
  #   scan_interval: 600
  #   group: "battery"

# Binary Sensors
binary_sensors: []
  # Add binary sensors here if needed
  # Example: Battery protection status, alarm states, etc.


# Calculated Sensors
calculated:
  # Battery 1 Voltage Spread - difference between max and min cell voltage across all modules
  - name: "Battery 1 Voltage Spread"
    unique_id: battery_1_voltage_spread
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    state: >
      {% set max_voltage = states('sensor.{PREFIX}_battery_1_max_voltage_of_cell') | float(0) %}
      {% set min_voltage = states('sensor.{PREFIX}_battery_1_min_voltage_of_cell') | float(0) %}
      {{ (max_voltage - min_voltage) | round(5) }}

  # Battery 1 Module Deviation Sensors - deviation from average module voltage
  # These sensors calculate the deviation of each module's max cell voltage from the average
  # Only modules that exist (have non-zero voltage) are included in the average calculation
  - name: "Battery 1 Module 1 Deviation"
    unique_id: battery_1_module_1_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 1"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v1 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 2 Deviation"
    unique_id: battery_1_module_2_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 2"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v2 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 3 Deviation"
    unique_id: battery_1_module_3_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 3"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v3 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 4 Deviation"
    unique_id: battery_1_module_4_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 4"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v4 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 5 Deviation"
    unique_id: battery_1_module_5_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 5"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v5 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 6 Deviation"
    unique_id: battery_1_module_6_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 6"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v6 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 7 Deviation"
    unique_id: battery_1_module_7_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 7"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v7 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  - name: "Battery 1 Module 8 Deviation"
    unique_id: battery_1_module_8_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 8"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {{ (v8 - avg) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  # Additional Battery Health & Balancing Metrics

  # Battery 1 Temperature Spread - difference between hottest and coldest module
  - name: "Battery 1 Temperature Spread"
    unique_id: battery_1_temperature_spread
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    state: >
      {% set max_temp = states('sensor.{PREFIX}_battery_1_max_temperature_of_module') | float(0) %}
      {% set min_temp = states('sensor.{PREFIX}_battery_1_min_temperature_of_module') | float(0) %}
      {{ (max_temp - min_temp) | round(5) }}

  # Battery 1 Average Module Voltage - average of all module max cell voltages
  - name: "Battery 1 Average Module Voltage"
    unique_id: battery_1_average_module_voltage
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {{ (sum / count) | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  # Battery 1 Max Module Deviation - largest absolute deviation from average
  - name: "Battery 1 Max Module Deviation"
    unique_id: battery_1_max_module_deviation
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {% set d1 = (v1 - avg) | abs if v1 > 0 else 0 %}
        {% set d2 = (v2 - avg) | abs if v2 > 0 else 0 %}
        {% set d3 = (v3 - avg) | abs if v3 > 0 else 0 %}
        {% set d4 = (v4 - avg) | abs if v4 > 0 else 0 %}
        {% set d5 = (v5 - avg) | abs if v5 > 0 else 0 %}
        {% set d6 = (v6 - avg) | abs if v6 > 0 else 0 %}
        {% set d7 = (v7 - avg) | abs if v7 > 0 else 0 %}
        {% set d8 = (v8 - avg) | abs if v8 > 0 else 0 %}
        {% set max_dev = [d1, d2, d3, d4, d5, d6, d7, d8] | max %}
        {{ max_dev | round(5) }}
      {% else %}
        {{ 0 }}
      {% endif %}

  # Battery 1 Voltage Imbalance Percentage - max deviation as percentage of average
  - name: "Battery 1 Voltage Imbalance Percentage"
    unique_id: battery_1_voltage_imbalance_percentage
    unit_of_measurement: "%"
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    state: >
      {% set v1 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set v2 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set v3 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set v4 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set v5 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set v6 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set v7 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set v8 = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set sum = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 %}
      {% set count = (v1 > 0) | int + (v2 > 0) | int + (v3 > 0) | int + (v4 > 0) | int + (v5 > 0) | int + (v6 > 0) | int + (v7 > 0) | int + (v8 > 0) | int %}
      {% if count > 0 %}
        {% set avg = sum / count %}
        {% set d1 = (v1 - avg) | abs if v1 > 0 else 0 %}
        {% set d2 = (v2 - avg) | abs if v2 > 0 else 0 %}
        {% set d3 = (v3 - avg) | abs if v3 > 0 else 0 %}
        {% set d4 = (v4 - avg) | abs if v4 > 0 else 0 %}
        {% set d5 = (v5 - avg) | abs if v5 > 0 else 0 %}
        {% set d6 = (v6 - avg) | abs if v6 > 0 else 0 %}
        {% set d7 = (v7 - avg) | abs if v7 > 0 else 0 %}
        {% set d8 = (v8 - avg) | abs if v8 > 0 else 0 %}
        {% set max_dev = [d1, d2, d3, d4, d5, d6, d7, d8] | max %}
        {% if avg > 0 %}
          {{ (max_dev / avg * 100) | round(5) }}
        {% else %}
          {{ 0 }}
        {% endif %}
      {% else %}
        {{ 0 }}
      {% endif %}

  # Battery 1 Module Cell Voltage Range - internal spread within each module (max - min cell voltage)
  - name: "Battery 1 Module 1 Cell Voltage Range"
    unique_id: battery_1_module_1_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 1"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_1') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 2 Cell Voltage Range"
    unique_id: battery_1_module_2_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 2"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_2') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 3 Cell Voltage Range"
    unique_id: battery_1_module_3_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 3"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_3') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 4 Cell Voltage Range"
    unique_id: battery_1_module_4_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 4"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_4') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 5 Cell Voltage Range"
    unique_id: battery_1_module_5_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 5"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_5') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 6 Cell Voltage Range"
    unique_id: battery_1_module_6_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 6"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_6') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 7 Cell Voltage Range"
    unique_id: battery_1_module_7_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 7"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_7') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  - name: "Battery 1 Module 8 Cell Voltage Range"
    unique_id: battery_1_module_8_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    condition: "modules >= 8"
    state: >
      {% set max_v = states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) %}
      {% set min_v = states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_8') | float(0) %}
      {{ (max_v - min_v) | round(5) }}

  # Battery 1 Max Module Cell Voltage Range - largest internal spread across all modules
  - name: "Battery 1 Max Module Cell Voltage Range"
    unique_id: battery_1_max_module_cell_voltage_range
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    precision: 5
    group: "battery_balancing"
    state: >
      {% set r1 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_1') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_1') | float(0)) | abs %}
      {% set r2 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_2') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_2') | float(0)) | abs %}
      {% set r3 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_3') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_3') | float(0)) | abs %}
      {% set r4 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_4') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_4') | float(0)) | abs %}
      {% set r5 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_5') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_5') | float(0)) | abs %}
      {% set r6 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_6') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_6') | float(0)) | abs %}
      {% set r7 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_7') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_7') | float(0)) | abs %}
      {% set r8 = (states('sensor.{PREFIX}_battery_1_max_cell_voltage_of_module_8') | float(0) - states('sensor.{PREFIX}_battery_1_min_cell_voltage_of_module_8') | float(0)) | abs %}
      {% set max_range = [r1, r2, r3, r4, r5, r6, r7, r8] | max %}
      {{ max_range | round(5) }}

  # Battery 1 Max/Min Voltage Cell Position Info - human-readable interpretation
  # Note: The position is a unique cell ID from the BMS, not a simple "Module X, Cell Y" coordinate
  # This sensor provides additional context about the cell position
  - name: "Battery 1 Max Voltage Cell Info"
    unique_id: battery_1_max_voltage_cell_info
    group: "battery_balancing"
    state: >
      {% set pos = states('sensor.{PREFIX}_battery_1_position_of_max_voltage_cell') | int(0) %}
      {% set volt = states('sensor.{PREFIX}_battery_1_max_voltage_of_cell') | float(0) %}
      {% if pos > 0 and volt > 0 %}
        Cell Position {{ pos }} ({{ "%.4f" | format(volt) }} V)
      {% else %}
        Unknown
      {% endif %}

  - name: "Battery 1 Min Voltage Cell Info"
    unique_id: battery_1_min_voltage_cell_info
    group: "battery_balancing"
    state: >
      {% set pos = states('sensor.{PREFIX}_battery_1_position_of_min_voltage_cell') | int(0) %}
      {% set volt = states('sensor.{PREFIX}_battery_1_min_voltage_of_cell') | float(0) %}
      {% if pos > 0 and volt > 0 %}
        Cell Position {{ pos }} ({{ "%.4f" | format(volt) }} V)
      {% else %}
        Unknown
      {% endif %}

  # Battery 1 Max/Min Temperature Module Position Info - human-readable interpretation
  # Note: The position is a unique module ID from the BMS
  # This sensor provides additional context about the module position and temperature
  - name: "Battery 1 Max Temperature Module Info"
    unique_id: battery_1_max_temperature_module_info
    group: "battery_balancing"
    state: >
      {% set pos = states('sensor.{PREFIX}_battery_1_position_of_max_temperature_of_module') | int(0) %}
      {% set temp = states('sensor.{PREFIX}_battery_1_max_temperature_of_module') | float(0) %}
      {% if pos > 0 and temp > 0 %}
        Module Position {{ pos }} ({{ "%.1f" | format(temp) }} °C)
      {% else %}
        Unknown
      {% endif %}

  - name: "Battery 1 Min Temperature Module Info"
    unique_id: battery_1_min_temperature_module_info
    group: "battery_balancing"
    state: >
      {% set pos = states('sensor.{PREFIX}_battery_1_position_of_min_temperature_of_module') | int(0) %}
      {% set temp = states('sensor.{PREFIX}_battery_1_min_temperature_of_module') | float(0) %}
      {% if pos > 0 and temp > 0 %}
        Module Position {{ pos }} ({{ "%.1f" | format(temp) }} °C)
      {% else %}
        Unknown
      {% endif %}
